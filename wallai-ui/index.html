<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WallAI Config</title>
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
</head>
<body>
  <h1>WallAI Config Editor</h1>
  <input type="file" id="import" accept=".db,.sqlite">
  <button id="export">Export DB</button>

  <h2>Tags</h2>
  <input type="text" id="tag-input" placeholder="New tag">
  <button id="add-tag">Add Tag</button>
  <ul id="tags"></ul>

  <h2>Groups</h2>
  <input type="text" id="group-input" placeholder="New group">
  <button id="add-group">Add Group</button>
  <ul id="groups"></ul>

  <h2>Favorites</h2>
  <select id="fav-select"></select>
  <ul id="favorites"></ul>

<script>
let SQL, db;

function createTables() {
  db.run(`CREATE TABLE IF NOT EXISTS providers(
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT CHECK(type IN ('text','image')) NOT NULL,
    base_url TEXT NOT NULL,
    api_key TEXT,
    UNIQUE(name, type)
  );`);
  db.run(`CREATE TABLE IF NOT EXISTS models(
    id INTEGER PRIMARY KEY,
    provider_id INTEGER NOT NULL REFERENCES providers(id),
    name TEXT NOT NULL,
    alias TEXT
  );`);
  db.run(`CREATE TABLE IF NOT EXISTS groups(
    id INTEGER PRIMARY KEY,
    name TEXT UNIQUE NOT NULL,
    prompt_model TEXT,
    image_model TEXT,
    tag_model TEXT,
    style_model TEXT,
    allow_nsfw BOOLEAN DEFAULT 1
  );`);
  db.run(`CREATE TABLE IF NOT EXISTS tags(
    id INTEGER PRIMARY KEY,
    name TEXT UNIQUE NOT NULL
  );`);
  db.run(`CREATE TABLE IF NOT EXISTS styles(
    id INTEGER PRIMARY KEY,
    name TEXT UNIQUE NOT NULL
  );`);
  db.run(`CREATE TABLE IF NOT EXISTS moods(
    id INTEGER PRIMARY KEY,
    name TEXT UNIQUE NOT NULL
  );`);
  db.run(`CREATE TABLE IF NOT EXISTS favorites(
    id INTEGER PRIMARY KEY,
    group_id INTEGER REFERENCES groups(id),
    filename TEXT NOT NULL,
    theme TEXT,
    style TEXT,
    mood TEXT,
    prompt TEXT,
    model TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );`);
  db.run(`CREATE TABLE IF NOT EXISTS defaults(
    key TEXT PRIMARY KEY,
    value TEXT
  );`);
}

function refreshTags() {
  const list = document.getElementById('tags');
  list.innerHTML = '';
  const res = db.exec('SELECT id, name FROM tags ORDER BY name');
  if (res[0]) {
    res[0].values.forEach(row => {
      const li = document.createElement('li');
      li.textContent = row[1];
      const del = document.createElement('button');
      del.textContent = 'Delete';
      del.onclick = () => {
        db.run('DELETE FROM tags WHERE id=?', [row[0]]);
        refreshTags();
      };
      li.appendChild(document.createTextNode(' '));
      li.appendChild(del);
      list.appendChild(li);
    });
  }
}

function refreshGroups() {
  const list = document.getElementById('groups');
  list.innerHTML = '';
  const res = db.exec('SELECT id, name, prompt_model, image_model, tag_model, style_model, allow_nsfw FROM groups ORDER BY name');
  if (res[0]) {
    res[0].values.forEach(row => {
      const li = document.createElement('li');
      const name = document.createElement('input');
      name.value = row[1];
      const pm = document.createElement('input');
      pm.value = row[2] || '';
      const im = document.createElement('input');
      im.value = row[3] || '';
      const nsfw = document.createElement('input');
      nsfw.type = 'checkbox';
      nsfw.checked = !!row[6];
      const save = document.createElement('button');
      save.textContent = 'Save';
      save.onclick = () => {
        db.run('UPDATE groups SET name=?, prompt_model=?, image_model=?, tag_model=?, style_model=?, allow_nsfw=? WHERE id=?', [name.value, pm.value, im.value, row[4] || '', row[5] || '', nsfw.checked ? 1 : 0, row[0]]);
        refreshGroups();
        refreshFavGroups();
      };
      li.appendChild(name);
      li.appendChild(document.createTextNode(' '));
      li.appendChild(pm);
      li.appendChild(document.createTextNode(' '));
      li.appendChild(im);
      li.appendChild(document.createTextNode(' '));
      li.appendChild(nsfw);
      li.appendChild(document.createTextNode(' '));
      li.appendChild(save);
      if (name.value !== 'main') {
        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.onclick = () => {
          db.run('DELETE FROM groups WHERE id=?', [row[0]]);
          refreshGroups();
          refreshFavGroups();
        };
        li.appendChild(document.createTextNode(' '));
        li.appendChild(del);
      }
      list.appendChild(li);
    });
  }
}

function refreshFavGroups() {
  const sel = document.getElementById('fav-select');
  sel.innerHTML = '';
  const res = db.exec('SELECT id, name FROM groups ORDER BY name');
  if (res[0]) {
    res[0].values.forEach(row => {
      const opt = document.createElement('option');
      opt.value = row[0];
      opt.textContent = row[1];
      sel.appendChild(opt);
    });
  }
  refreshFavorites();
}

function refreshFavorites() {
  const gid = parseInt(document.getElementById('fav-select').value, 10);
  const list = document.getElementById('favorites');
  list.innerHTML = '';
  if (isNaN(gid)) return;
  const res = db.exec('SELECT id, filename, prompt FROM favorites WHERE group_id=? ORDER BY created_at DESC', [gid]);
  if (res[0]) {
    res[0].values.forEach(row => {
      const li = document.createElement('li');
      li.textContent = row[1];
      const del = document.createElement('button');
      del.textContent = 'Delete';
      del.onclick = () => {
        db.run('DELETE FROM favorites WHERE id=?', [row[0]]);
        refreshFavorites();
      };
      li.appendChild(document.createTextNode(' '));
      li.appendChild(del);
      list.appendChild(li);
    });
  }
}

async function init() {
  SQL = await initSqlJs({
    locateFile: f => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${f}`
  });
  db = new SQL.Database();
  createTables();
  refreshTags();
  refreshGroups();
  refreshFavGroups();
}

document.getElementById('add-tag').onclick = () => {
  const tag = document.getElementById('tag-input').value.trim();
  if (!tag) return;
  db.run('INSERT OR IGNORE INTO tags(name) VALUES(?)', [tag]);
  document.getElementById('tag-input').value = '';
  refreshTags();
};

document.getElementById('add-group').onclick = () => {
  const grp = document.getElementById('group-input').value.trim();
  if (!grp) return;
  db.run('INSERT OR IGNORE INTO groups(name) VALUES(?)', [grp]);
  document.getElementById('group-input').value = '';
  refreshGroups();
  refreshFavGroups();
};

document.getElementById('fav-select').onchange = refreshFavorites;

document.getElementById('export').onclick = () => {
  const data = db.export();
  const blob = new Blob([data], {type: 'application/octet-stream'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'config.db';
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('import').onchange = evt => {
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const u8 = new Uint8Array(e.target.result);
    db = new SQL.Database(u8);
    createTables();
    refreshTags();
    refreshGroups();
    refreshFavGroups();
  };
  reader.readAsArrayBuffer(file);
};

init();
</script>
</body>
</html>
